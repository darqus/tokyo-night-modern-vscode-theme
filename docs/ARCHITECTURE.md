# Архитектура цветовой системы

Этот документ описывает слои цветовой системы темы, принципы проектирования и гарантии качества. Цель — обеспечить предсказуемость изменений, консистентность и доступность (контраст, прозрачности) во всём UI VS Code.

## Слоистая модель

- Базовая палитра (`src/core/palette.ts`)

  - Набор статичных базовых цветов (нейтральные и акцентные).
  - Только валидные hex (тип `Hex`), без операций.

- Утилиты цвета (`src/core/utils.ts`)

  - mix, lighten, darken, withAlpha — минимальная математика над цветами с кэшированием.
  - Предпочтительно использовать их только внутри интерфейсной палитры.

- Интерфейсная палитра (`src/core/interface.ts`)

  - Единый источник правды для всех ролей UI.
  - Группы:
    - `bg` — поверхности (base, elevated, overlay, hover/active/selection и т.д.).
    - `text` — текстовые роли (primary/inverse/muted/subtle/inactive, lineNumber).
    - `border` — границы (default/focus/separatorBackground).
    - `button` — первичные/вторичные кнопки (bg/fg/hover/border/separator).
    - `state` — семантические состояния (info/success/warning/error + hover).
    - `diff`, `git`, `minimap`, `dropdown`, `scmGraph` — специализированные группы.
    - `derived` — производные наборы для сложных зон: `link`, `terminal`, `overlays.dropBackground`, `findMatch`, `inlineChat`, `blockquote`.
    - `charts` — палитра для `charts.*` токенов (ранее использовались прямые цвета из базы).
  - Важно: генератор темы не использует `basePalette` напрямую — только роли отсюда.

- Генераторы (`src/generators/`)

  - `theme.ts` — маппинг ролей интерфейсной палитры на VS Code color tokens.
  - `tokens.ts` — синтаксические токены (TextMate/semantic) от `syntaxPalette`.
  - Строго избегаем прямых ссылок на `basePalette`.

## Политики и инварианты

- Прозрачности (требующиеся VS Code): все `dropBackground`, `hoverHighlight`, `rangeHighlight`, `findMatchHighlight` — полупрозрачные. Покрыты тестами.
- Контраст: для ключевых пар (activity bar/tab inactive, кнопки) поддерживаем минимальные пороги. См. `tests/unit/contrast.basic.test.ts`.
- Единообразие ссылок и терминала: `derived.link` согласован с `derived.terminal` (ANSI синие/циановый), чтобы ссылки и пути в терминале не выглядели «двухтоновыми».
- Изоляция слоёв: добавление/изменение цветов — через `interfacePalette`. Генератор не должен тянуть `basePalette`.

## Почему добавлен раздел charts и базовые ANSI в derived.terminal

- Ранее часть токенов (`charts.*`, `terminal.ansi*`) брала цвета прямо из `basePalette`, что ломало идею единого слоя ролей. Теперь:
  - `interfacePalette.charts` содержит все цвета для диаграмм.
  - `interfacePalette.derived.terminal` содержит как базовые ANSI (black/red/green/yellow/magenta/white), так и bright/смешанные оттенки.
- Это упростит глобальные правки: изменение тона/глубины/контраста происходит централизованно.

## Тестовый контур качества

- Снапшот темы — стабильность итогового JSON.
- Валидация прозрачностей и допустимости токенов.
- Базовые контрастные проверки (advisory) — не заменяют ручной визуальной оценки, но предотвращают регрессии «слияния» неактивных элементов с фоном.

## Роадмап улучшений

- Registry токенов: таблица «VS Code token → роль/поверхность/политика альфы/устаревание». Даст лучшую обозримость покрытия и автоматические проверки.
- Перцептуальная математика: перевод mix/lighten/darken на OKLCH (например, culori) для более стабильной визуальной яркости/тональности.
- Поверхностно-зависимые текстовые роли: `text.onBase`, `text.onElevated`, `text.onOverlay` — для гарантии нужного контраста на разных слоях.

## Как вносить изменения

1) Добавьте/исправьте цвет в `interfacePalette` (при необходимости — новую подгруппу).
2) Привяжите роль к VS Code токену в `src/generators/theme.ts`.
3) Запустите тесты. Убедитесь, что снапшоты/валидации проходят.
4) Оцените визуально критичные зоны: меню, вкладки, терминал, поиск.

Такой подход сохраняет простоту поддержки, предотвращает регрессии контраста/прозрачности и облегчает эволюцию темы без «скрытых» связей.
