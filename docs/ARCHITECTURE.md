# Архитектура цветовой системы

Обновлено после упрощения (DSL-мэппинг, контроль числа токенов, депрекация legacy).
Этот документ описывает слои цветовой системы темы, принципы проектирования и гарантии качества. Цель — обеспечить предсказуемость изменений, консистентность и доступность (контраст, прозрачности) во всём UI VS Code при минимуме дублирования.

## Слоистая модель

- Базовая палитра (`src/core/palette.ts`)

  - Набор статичных базовых цветов (нейтральные и акцентные).
  - Только валидные hex (тип `Hex`), без операций.

- Утилиты цвета (`src/core/utils.ts`)

  - mix, lighten, darken, withAlpha — минимальная математика над цветами с кэшированием.
  - Предпочтительно использовать их только внутри интерфейсной палитры.

- Интерфейсная палитра (`src/core/interface.ts`)

  - Единый источник правды для всех ролей UI.
  - Группы:
    - `bg` — поверхности (base, elevated, overlay, hover/active/selection и т.д.).
    - `text` — текстовые роли (primary/inverse/muted/subtle/inactive, lineNumber).
    - `border` — границы (default/focus/separatorBackground).
    - `button` — первичные/вторичные кнопки (bg/fg/hover/border/separator).
    - `state` — семантические состояния (info/success/warning/error + hover).
    - `diff`, `git`, `minimap`, `dropdown`, `scmGraph` — специализированные группы.
    - `derived` — производные наборы для сложных зон: `link`, `terminal`, `overlays.dropBackground`, `findMatch`, `inlineChat`, `blockquote`.
    - `charts` — палитра для `charts.*` токенов (ранее использовались прямые цвета из базы).
  - Важно: генератор темы не использует `basePalette` напрямую — только роли отсюда.

- Генераторы (`src/generators/`)

  - `modernInterfaceMapping.ts` — декларативный DSL (`tokenConfig`) + функция `createTokens()` — ЕДИНСТВЕННЫЙ источник мэппинга UI → VS Code color tokens.
  - `interfaceMapping.ts` — LEGACY shim (реэкспорт DSL + предупреждение). Не изменять, будет удалён в мажорном релизе.
  - `theme.ts` — сборка итоговой темы (интерфейсные цвета через DSL, затем текстовые/semantic токены).
  - `tokens.ts` — синтаксические токены (TextMate/semantic) от `syntaxPalette`.
  - Никаких прямых импортов `basePalette` вне `interface.ts` (проверяется тестом `generator.no-basepalette`).

## Политики и инварианты

- Прозрачности (требующиеся VS Code): все `dropBackground`, `hoverHighlight`, `rangeHighlight`, `findMatchHighlight` — полупрозрачные. Покрыты тестами.
- Контраст: для ключевых пар (activity bar/tab inactive, кнопки) поддерживаем минимальные пороги. См. `tests/unit/contrast.basic.test.ts`.
- Единообразие ссылок и терминала: `derived.link` согласован с `derived.terminal` (ANSI синие/циановый), чтобы ссылки и пути в терминале не выглядели «двухтоновыми».
- Изоляция слоёв: добавление/изменение цветов — через `interfacePalette`. Генератор не должен тянуть `basePalette`.

## Почему добавлен раздел charts и базовые ANSI в derived.terminal

- Ранее часть токенов (`charts.*`, `terminal.ansi*`) брала цвета прямо из `basePalette`, что ломало идею единого слоя ролей. Теперь:
  - `interfacePalette.charts` содержит все цвета для диаграмм.
  - `interfacePalette.derived.terminal` содержит как базовые ANSI (black/red/green/yellow/magenta/white), так и bright/смешанные оттенки.
- Это упростит глобальные правки: изменение тона/глубины/контраста происходит централизованно.

## Тестовый контур качества

Ключевые принципы:

1. **Стабильность структуры** — снапшот итоговой темы + отдельный тест `theme.count.test.ts` (фиксирует количество цветовых токенов). Любое непреднамеренное удаление токена приводит к падению теста.
2. **Валидация схемы и denylist** — объединена в один тест `forbidden.and.allowed.tokens.test.ts`.
3. **Политики прозрачности/альфы** — централизовано через `tokenRegistry.test.ts` + `transparencyRules.test.ts`.
4. **Контраст (advisory)** — `contrast.basic` и `contrast.alphaAware` для предотвращения грубых регрессий.
5. **Правило "слоёв"** — тест `generator.no-basepalette` не даёт утечь прямым импортам базы в генераторы.
6. **Перцептуальные проверки (OKLCH)** — отдельные target-тесты на тени/бордеры (`shadows.oklch`, `border.*`, `peekView.*`).
7. **Тихие логи в CI** — можно включить `QUIET=1 npm run build` или подавление логов в тестах (автоматически через setup).

## Роадмап улучшений

| Задача | Статус | Комментарий |
|--------|--------|-------------|
| Token Registry таблица (doc) | planned | Автогенерация markdown из `tokenConfig` |
| Полный переход на OKLCH для mix/lighten | planned | Точнее chroma, меньше выцветания голубых |
| Частичные снапшоты (группы) | optional | Пока один основной снапшот + счётчик достаточно |
| Удаление legacy файлов | next major | `interfaceMapping.ts`, потенциально `themeEngine.ts` |
| Генерация docs из DSL | planned | Скрипт формирует таблицы по группам |

## Как вносить изменения

1. Добавьте/скорректируйте роль в `interfacePalette` (при необходимости — новую подгруппу). Для вычисляемых — обновите/добавьте в `derived`.
2. Добавьте новый VS Code токен в `tokenConfig` (группа в `modernInterfaceMapping.ts`). Описание (`description`) помогает автогенерации docs.
3. Запустите `npm test` — упадёт либо счётчик токенов (если забыли что-то), либо forbid/alpha проверки.
4. При ожидаемом визуальном изменении — обновите снапшот: `npm run test:update`.
5. Вручную проверьте критичные зоны (меню, вкладки, терминал, hover/selection). Инспектируйте контрастные роли, если добавили новые фоны.
6. Для CI без шума используйте `QUIET=1 npm run build`.

Такой подход снижает когнитивную нагрузку (единый DSL), защищает от регрессий (кол-во токенов + валидаторы) и облегчает эволюцию темы без «скрытых» путей.

---
**Legacy**: `interfaceMapping.ts` и `themeEngine.ts` не должны применяться в новых изменениях. Для внешних потребителей оставлен только совместимый реэкспорт. В мажорном релизе — удаление.
